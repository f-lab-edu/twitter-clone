<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="clone.twitter.repository.TweetMapper">
  <select id="findInitialTimelinePageTweets" resultType="tweetResultMap">
    SELECT
      id,
      text,
      user_id AS userId,
      created_at AS createdAt
    FROM
      tweet
    WHERE
      (
        user_id IN (
          SELECT followee_id
          FROM follow
          WHERE follower_id = #{userId}
        )
      OR user_id = #{userId}
    )
    ORDER BY
      created_at DESC
    LIMIT
      #{limit}
  </select>

  <select id="findNextTimelinePageTweets" resultType="tweetResultMap">
    SELECT
      id,
      text,
      user_id AS userId,
      created_at AS createdAt
    FROM
      tweet
    WHERE
      (user_id IN (
        SELECT
          followee_id
        FROM
          follow
        WHERE
          follower_id = #{userId}
        )
      OR user_id = #{userId}
    )
    AND created_at &lt; #{createdAt}
    ORDER BY
      created_at DESC
    LIMIT
      #{limit}
  </select>

  <select id="findById" resultType="tweetResultMap">
    SELECT
      id,
      text,
      user_id AS userId,
      created_at AS createdAt
    FROM
      tweet
    where
      id = #{id}
  </select>

  <insert id="save">
    INSERT INTO
      tweet (id, text, user_id, created_at)
    VALUES
      (#{id, jdbcType=CHAR}, #{text}, #{userId}, #{createdAt})
  </insert>

  <delete id="deleteById">
    DELETE FROM
      tweet
    WHERE
      id = #{id}
  </delete>
  
  <select id="findByListOfTweetsByUserIds" resultType="tweetResultMap">
    SELECT
      id,
      text,
      user_id AS userId,
      created_at AS createdAt
    FROM
      tweet
    WHERE
      user_id IN
        <foreach item="userId" collection="userIds" open="(" separator="," close=")">
          #{userId}
        </foreach>
    ORDER BY
      created_at DESC
    LIMIT
      #{limit}
  </select>
  <resultMap id="tweetResultMap" type="Tweet">
    <result property="id" column="id"/>
    <result property="text" column="text"/>
    <result property="userId" column="userId"/>
    <!-- 'created_at' 컬럼을 Timestamp로 매핑 -->
    <result property="createdAt" column="createdAt" jdbcType="TIMESTAMP" javaType="java.time.LocalDateTime"/>
  </resultMap>
</mapper>
